
        Shell Container  |  BT Container  |  Store Container
                                   ^
                                   |
+----------------------------------------------------------------------+
|                       EnviroCert Dev Image                           |
+-----------------+-----------+------+-------------+-------------------+
|      pybase     |  vollog   |      |  pip cache  |  /brightlink_dev  |
+-----------------+-----------+      +-------------+-------------------+
|  ubuntu:trusty  | miniscule |                    host
+-----------------+-----------+


Required Host System Tools
--------------------------

* docker
* postgresql-client-9.3
* jq

Giving non-root access:

    https://docs.docker.com/installation/ubuntulinux/#giving-non-root-access

Building the Base Images
------------------------

cd postgres/
sudo docker build -t postgres .

cd miniscule/
sudo docker build -t miniscule .

cd pybase/
sudo docker build -t pybase .

cd vol/
sudo ./build.sh

cd nginx
docker build -t clarus_nginx .

cd clarus_base/
<edit build.sh for paths>
sudo ./build.sh


Building a Client
-----------------

cd client_db/
sudo ./build.sh cidq

cd client_image/
<edit build.sh for paths>
sudo ./build.sh CIDQ cidq

tools/fetch_db.sh cidq

psql -h $(sudo docker inspect cidq_db | jq -r '.[0].NetworkSettings.IPAddress') postgres postgres < cidq_schema.sql
pg_restore -h $(sudo docker inspect cidq_db | jq -r '.[0].NetworkSettings.IPAddress') -U postgres -d cidq_data cidq_data.pgdump


Working with Docker
-------------------

Tail server logs::

    while true ; do docker attach --sig-proxy=false cidq_server | grep -E --color 'blcore.events|$' ; sleep 2 ; done


Nginx
-----

docker run -d -p 80:80 --link nha_server:appserver -v ~/source/brightlink/brighttrac:/clarus -v ~/source/brightlink/nha:/custom -v ~/source/brightlink/modules-git/blcore:/blcore -v ~/source/brightlink/modules-git/blwebtop:/webtop --name nha_nginx clarus_nginx

--link nha_server:appserver

    Container endpoint for proxied requests. Anything not served
    statically will be redirected here.


-v ~/source/brightlink/brighttrac:/clarus
-v ~/source/brightlink/nha:/custom
-v ~/source/brightlink/modules-git/blcore:/blcore
-v ~/source/brightlink/modules-git/blwebtop:/webtop

    Static file locations. Modifying the paths on the left
    (particularly for /custom) allows resuing the same image for
    different clients by adjusting the custom static content location.sudo docker build -t pybase .


“Load balancer”
---------------

docker run -d -v /var/run/docker.sock:/docker.sock --name wacos cpuguy83/docker-grand-ambassador -name wacos_nginx -sock /docker.sock
